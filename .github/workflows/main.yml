name: Check & test & build
on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  version_check:
    name: Validate VERSION change
    runs-on: ubuntu-latest
    # Only run this check for PRs, not direct pushes to main
    if: github.event_name == 'pull_request'
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history to compare with base branch

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Check if VERSION file changed
        run: |
          # Get the base branch (usually main)
          BASE_BRANCH="${{ github.base_ref }}"

          # Check if VERSION file changed in this PR
          if git diff origin/$BASE_BRANCH...HEAD --name-only | grep -q "^VERSION$"; then
            echo "âœ… VERSION file changed in this PR"
            
            # Validate the new version format
            NEW_VERSION=$(cat VERSION | tr -d '\n\r')
            echo "New version: $NEW_VERSION"
            
            # Validate version format using Python script
            python .github/scripts/version_utils.py validate "$NEW_VERSION"
            
            echo "âœ… VERSION change is valid"
          else
            echo "âŒ ERROR: VERSION file must be updated in every PR"
            echo "Please update the VERSION file to reflect your changes:"
            echo "  - Bug fixes: increment patch version (0.2.1 â†’ 0.2.2)"
            echo "  - New features: increment minor version (0.2.1 â†’ 0.3.0)"
            echo "  - Breaking changes: increment major version (0.2.1 â†’ 1.0.0)"
            exit 1
          fi

  check:
    name: Quality & security checks
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Lint Go Code
        run: make check

  test:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Run unit tests
        run: make test-unit

  integration_test:
    name: Integration tests
    runs-on: ubuntu-latest
    needs: [check]
    # Skip version_check dependency for direct pushes to main (not PRs)
    if: always() && (needs.check.result == 'success' || needs.check.result == 'skipped')
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Run integration tests
        run: make test-integration

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, integration_test]
    if: always() && (needs.test.result == 'success' && needs.integration_test.result == 'success')
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true

      - name: Build binaries
        run: make build

  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [version_check, check, test, integration_test, build]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Version check (only for PRs)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ needs.version_check.result }}" == "success" ]; then
              echo "| ðŸ“‹ Version Check | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.version_check.result }}" == "failure" ]; then
              echo "| ðŸ“‹ Version Check | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ðŸ“‹ Version Check | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| ðŸ“‹ Version Check | â­ï¸ | Skipped (not a PR) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Quality checks
          if [ "${{ needs.check.result }}" == "success" ]; then
            echo "| ðŸ” Quality & Security | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.check.result }}" == "failure" ]; then
            echo "| ðŸ” Quality & Security | âš ï¸ | Failed (non-blocking) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” Quality & Security | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Unit tests
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "| ðŸ§ª Unit Tests | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" == "failure" ]; then
            echo "| ðŸ§ª Unit Tests | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª Unit Tests | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Integration tests
          if [ "${{ needs.integration_test.result }}" == "success" ]; then
            echo "| ðŸ”— Integration Tests | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.integration_test.result }}" == "failure" ]; then
            echo "| ðŸ”— Integration Tests | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”— Integration Tests | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| ðŸ—ï¸ Build | âœ… | Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "| ðŸ—ï¸ Build | âŒ | Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ Build | â­ï¸ | Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.integration_test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
            if [ "${{ github.event_name }}" == "pull_request" ] && [ "${{ needs.version_check.result }}" != "success" ]; then
              echo "## âš ï¸ Overall Status: Partial Success" >> $GITHUB_STEP_SUMMARY
              echo "All tests and build passed, but version check failed." >> $GITHUB_STEP_SUMMARY
            else
              echo "## âœ… Overall Status: Success" >> $GITHUB_STEP_SUMMARY
              echo "All jobs completed successfully!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ Overall Status: Failed" >> $GITHUB_STEP_SUMMARY
            echo "One or more critical jobs failed." >> $GITHUB_STEP_SUMMARY
          fi
